# ------------------------------------------------------
#	Wordpress Twig
#	(c) 2016 Inkton
#

wordpress_init() {
	yell "-> wordpress init"; 

	NEST_APP="wordpress"
	NEST_APP_VERSION=""
	NEST_APP_PACKAGES='[]'

	init_after wordpress
}

wordpress_shutdown() {
	shutdown_before wordpress
}

wordpress_before_create() {
	do_things before create wordpress
}

wordpress_after_create() { 
	do_things after create wordpress
}

wordpress_before_install() {
	do_things before install wordpress
}

wordpress_after_install() { 
	yell "-> install wp-cli";

	if [ -f /usr/local/nest/sbin/wp ]; then
		try /usr/bin/sudo cp /usr/local/nest/sbin/wp /bin
	else
		try cd /bin
		try /usr/bin/sudo curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
		try /usr/bin/sudo chmod +x wp-cli.phar
		try /usr/bin/sudo mv wp-cli.phar wp
	fi
	
	. $NEST_FOLDER/utils/db
	db_init

	SITE_HOME=$(cat $NEST_APP_REGISTRY_PATH | jq -r '.site.home')
	SITE_EMAIL=$(cat $NEST_APP_REGISTRY_PATH | jq -r '.site.email')
	USER_LOGIN_NAME=$(cat $NEST_APP_REGISTRY_PATH | jq -r '.location.name')
	
	if [ ! -f /var/app/public/wp-settings.php ]; then
		try sudo wp core download --path=/var/app/public
	else
		sudo rm -f /var/app/public/wp-config.php
	fi

	try sudo wp core config --path=/var/app/public --dbprefix=wp_ --dbname=$DB_NAME --dbuser=$DB_USER --dbpass=$DB_PASSWORD --dbhost=db --extra-php <<PHP
define('FS_METHOD','$NEST_WP_FS_METHOD');
define('WP_POST_REVISIONS','$NEST_WP_POST_REVISIONS');
PHP
	try sudo wp core install --path=/var/app/public \
		--title="Hello World" \
		--url=$SITE_HOME \
		--admin_email=$SITE_EMAIL \
		--admin_user=$USER_LOGIN_NAME \
		--admin_password=$DB_PASSWORD

	do_things after install wordpress
}

wordpress_before_update() {
	yell "-> before_wordpress_update"; 
	do_things before update wordpress
}

wordpress_after_update() { 
	yell "-> after_wordpress_update";

	run_cmd "/usr/bin/sudo /sbin/apk --progress update" "$NEST_APP_PACKAGES"

	try /bin/wp cli update --yes

	do_things after update wordpress
}

wordpress_before_upgrade() {
	yell "-> before_wordpress_upgrade";   
	do_things before upgrade wordpress
} 

wordpress_after_upgrade() { 
	yell "-> after_wordpress_upgrade"; 
	run_cmd "/usr/bin/sudo /sbin/apk --progress --update upgrade" "$NEST_APP_PACKAGES"
	do_things after upgrade wordpress
}

wordpress_before_remove() {
	do_things before remove wordpress
}

wordpress_after_remove() { 
	do_things after remove wordpress
}

wordpress_before_info() {
	do_things before info wordpress
}

wordpress_after_info() { 
	yell "-> after_wordpress_info";

	try wp --info

	do_things after info wordpress
}

wordpress_before_up() {
	do_things before up wordpress
}

wordpress_after_up() {
	do_things after up wordpress
}

wordpress_before_down() {
	do_things before down wordpress
} 

wordpress_after_down() {              
	do_things after down wordpress
}

wordpress_before_daily() {
	do_things before daily wordpress
}

wordpress_after_daily() {
	do_things after daily wordpress
}
